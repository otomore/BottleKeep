# BottleKeep MVP機能定義書

## 1. MVPの基本方針

### 1.1 MVP（最小実用製品）とは
BottleKeepの**初回リリース**で実装する最小限の機能セット。個人のウイスキーコレクション管理という**コアバリュー**を提供し、継続的に使用できる状態を目指す。

### 1.2 成功基準
- 100本程度のウイスキーコレクションを問題なく管理できる
- 日常的な在庫確認・更新作業がスムーズに行える（操作時間3秒以内）
- データが安全に保存され、アプリクラッシュや誤操作でも失われない（データ損失ゼロ）
- iPhone/iPadの両方で快適に使用できる（起動時間2秒以内）
- クラッシュ率1%以下を維持
- 最初の1週間で10本以上のボトル登録が完了できる

### 1.3 開発制約
- **開発期間**: 個人開発のため期限なし、ただし段階的リリースを重視
- **技術リスク最小化**: 新技術の挑戦よりも安定動作を優先
- **シンプル設計**: 複雑な機能は後回し、まず基本機能を確実に

## 2. MVP機能一覧

### 2.1 P0機能（最優先・リリース必須）

#### 2.1.1 データ基盤
| 機能名 | 詳細 | 受け入れ基準 |
|--------|------|-------------|
| **Core Dataモデル設計** | Bottle・Photoエンティティの実装 | Entity定義とリレーション設定完了 |
| **ローカルデータ操作** | CRUD操作の基本実装 | ボトル追加・編集・削除・表示ができる |
| **データ永続化** | アプリ再起動後もデータが保持される | データ消失ゼロ、安全な保存 |

#### 2.1.2 基本UI構造
| 機能名 | 詳細 | 受け入れ基準 |
|--------|------|-------------|
| **ボトル一覧画面** | リスト形式でのボトル表示 | 登録したボトルが一覧表示される |
| **ボトル登録画面** | 新規ボトルの手動登録 | 基本情報（名前・蒸留所・度数・容量）を入力できる |
| **ボトル詳細画面** | 個別ボトルの詳細情報表示・編集 | 全情報表示と編集が可能 |

#### 2.1.3 コア在庫管理機能
| 機能名 | 詳細 | 受け入れ基準 |
|--------|------|-------------|
| **基本情報登録** | 銘柄・蒸留所・度数・容量の記録 | 必須フィールドが正しく保存される |
| **残量管理** | 現在の残量をml単位で記録 | 残量の表示・更新が正確 |
| **残量視覚化** | パーセンテージ表示とプログレスバー | 直感的な残量把握ができる |
| **写真保存** | ボトル写真の撮影・保存・表示 | 1枚以上の写真が保存・表示される |

### 2.2 P1機能（重要・MVP後期に実装）

#### 2.2.1 検索・フィルタリング
| 機能名 | 詳細 | 受け入れ基準 |
|--------|------|-------------|
| **基本検索** | 銘柄名・蒸留所名での検索 | 部分一致検索が動作する |
| **簡単フィルタ** | 残量状況（残りわずか・十分）での絞り込み | フィルタが正常に動作する |
| **基本ソート** | 名前・購入日・残量でのソート | ソート機能が正常に動作する |

#### 2.2.2 使いやすさ向上
| 機能名 | 詳細 | 受け入れ基準 |
|--------|------|-------------|
| **購入情報記録** | 購入日・価格・店舗の記録 | オプション情報として記録できる |
| **開栓日記録** | ボトルを開けた日の記録 | 開栓状態の管理ができる |
| **飲酒記録** | 消費量の記録機能 | 何ml飲んだかを記録できる |
| **メモ機能** | 簡単なテイスティングノート | 自由記述のメモが保存できる |

#### 2.2.3 iPad対応
| 機能名 | 詳細 | 受け入れ基準 |
|--------|------|-------------|
| **アダプティブUI** | iPhone/iPadの画面サイズ対応 | 両デバイスで快適に操作できる |
| **大画面活用** | iPadでの効率的なレイアウト | 大画面のメリットが活かされている |

**iPad固有の仕様詳細**:
- **一覧画面**: 2カラムレイアウト (リスト + 詳細)
- **登録画面**: サイドバイサイド配置 (フォーム + プレビュー)
- **写真表示**: グリッド表示時に大きなサムネイル使用
- **ナビゲーション**: SplitView対応でマスター・ディテール構成
- **最小サポート**: iPad (第8世代) / iPad Air (第4世代) / iPad Pro (全世代)
- **方向対応**: Portrait/Landscape両対応

### 2.3 P2機能（将来機能・MVP対象外）

以下は**MVP完成後**に段階的に実装する機能として位置づける：

#### 除外する機能
- CloudKit同期（安定性を優先し、まずローカル完成を目指す）
- 統計・分析機能（データが蓄積されてから価値が出る）
- マネタイズ機能（広告・アフィリエイト・課金）
- ソーシャル機能（コレクション共有・評価システム）
- Apple Watch対応・ウィジェット
- バーコードスキャン（実装複雑度が高い）
- 高度な通知機能
- データエクスポート機能

## 3. 開発フェーズ計画

### 3.1 フェーズ1: データ基盤構築（1-2週間目標）
**目標**: データが保存・読み出しできる状態

#### 技術的依存関係
- **前提条件**: Xcode 15.0+、iOS 16.0+ Deployment Target
- **フレームワーク**: SwiftUI、Core Data、Foundation
- **外部依存**: なし（iOS標準のみ）
- **開発環境**: Mac（AWS または Mac mini）

1. **Core Dataモデル設計**
   - **Bottle Entity**:
     - id: UUID (Primary Key)
     - name: String (銘柄名, 必須, 100文字以内)
     - distillery: String (蒸留所, 必須, 100文字以内)
     - abv: Double (アルコール度数, 0.0-100.0)
     - volume: Int32 (総容量ml, 50-5000の範囲)
     - remainingVolume: Int32 (残量ml, 0-volume値)
     - openedDate: Date? (開栓日, Optional)
     - purchaseDate: Date (購入日, デフォルト: 今日)
     - purchasePrice: Decimal? (購入価格, Optional)
     - shop: String? (購入店舗, Optional, 100文字以内)
     - notes: String? (メモ, Optional, 1000文字以内)
     - createdAt: Date (作成日時, 自動設定)
     - updatedAt: Date (更新日時, 自動更新)
   - **Photo Entity**:
     - id: UUID (Primary Key)
     - bottleID: UUID (Bottleへの外部キー)
     - fileName: String (UUIDベースのファイル名)
     - isMain: Bool (メイン写真フラグ, デフォルト: false)
     - fileSize: Int64 (ファイルサイズbyte)
     - createdAt: Date (作成日時)
   - **リレーションシップ**: Bottle ←→ Photo (One-to-Many)

2. **基本データ操作実装**
   - **BottleRepository**:
     - func create(bottle: Bottle) throws -> Bottle
     - func fetch(predicate: NSPredicate?) throws -> [Bottle]
     - func update(bottle: Bottle) throws -> Bottle
     - func delete(bottleID: UUID) throws
     - func fetchByID(_ id: UUID) throws -> Bottle?
   - **PhotoRepository**:
     - func savePhoto(image: UIImage, bottleID: UUID) throws -> Photo
     - func deletePhoto(photoID: UUID) throws
     - func loadImage(fileName: String) -> UIImage?
   - **エラーハンドリング**:
     - CoreDataError enum定義
     - ValidationError enum定義
     - 適切なthrows文での例外処理

3. **画像保存システム**
   - **保存場所**: Documents/Photos/ディレクトリ
   - **ファイル命名**: "${UUID}.jpg"形式
   - **画像処理**:
     - 最大解像度: 2048x2048px (縦横比維持)
     - JPEG圧縮率: 0.8 (80%品質)
     - 最大ファイルサイズ: 2MB
   - **サムネイル生成**: 512x512pxのサムネイル自動生成

### 3.2 フェーズ2: 基本UI実装（2-3週間目標）
**目標**: 手動でボトルを追加・表示・編集できる

#### 3.2.1 アーキテクチャ設計
- **パターン**: MVVM (Model-View-ViewModel) 採用
- **データフロー**: Repository → ViewModel → View
- **依存性注入**: @ObservableObjectと@StateObject使用
- **状態管理**: @State, @Binding, @Publishedで適切に分離

#### 3.2.2 UIコンポーネント実装
1. **ボトル一覧画面 (BottleListView)**
   - NavigationStack + List構成
   - LazyVStackでパフォーマンス最適化
   - サムネイルは512pxサイズ使用
   - スワイプアクション(編集/削除)対応

2. **ボトル登録画面 (BottleFormView)**
   - Form + Sectionで構造化
   - リアルタイムバリデーション
   - PhotosPickerで写真選択
   - カメラ撮影はImagePickerラッパー使用

3. **ボトル詳細画面 (BottleDetailView)**
   - ScrollView + VStack構成
   - 残量スライダーで直感操作
   - 写真ギャラリー表示
   - 編集モード切り替え機能

### 3.3 フェーズ3: 機能完成（1-2週間目標）
**目標**: 日常使いできる完成度

1. **検索・フィルタリング実装**
   - 検索バーの追加
   - 基本フィルタ機能
   - ソート機能

2. **iPad対応**
   - レスポンシブデザイン
   - 大画面最適化

3. **品質向上**
   - バグ修正
   - パフォーマンス調整
   - エラーハンドリング強化

### 3.4 フェーズ4: MVP完成（1週間目標）
**目標**: 継続使用可能な安定版

1. **総合テスト**
   - 機能テスト
   - デバイステスト
   - パフォーマンステスト

2. **ドキュメント整備**
   - 使い方説明
   - 技術ドキュメント更新

## 4. 受け入れテスト基準

### 4.1 基本動作テスト
- [ ] 新しいボトルが正常に登録できる
- [ ] 登録したボトルが一覧に表示される
- [ ] ボトルの詳細情報が正しく表示される
- [ ] 残量の更新が正確に反映される
- [ ] 写真の撮影・保存・表示ができる
- [ ] アプリを再起動してもデータが保持される

### 4.2 品質基準
- [ ] アプリクラッシュが発生しない
- [ ] データ消失が発生しない
- [ ] 基本操作が1秒以内に完了する
- [ ] iPhone/iPadの両方で問題なく動作する
- [ ] 100件のボトルを登録してもパフォーマンス劣化なし

### 4.3 ユーザビリティ基準
- [ ] 初回利用時に操作方法が理解できる
- [ ] 検索機能で目的のボトルが見つけられる
- [ ] 残量更新が直感的に行える
- [ ] 写真撮影が簡単に行える

### 4.4 エラーハンドリングテスト
- [ ] カメラ許可拒否時の適切なメッセージ表示
- [ ] ストレージ不足時の警告と代替手段提示
- [ ] データ保存失敗時のリトライ機能動作
- [ ] ネットワーク不安定時のオフライン動作継続
- [ ] アプリクラッシュ後のデータ整合性確認

## 5. パフォーマンス最適化戦略

### 5.1 メモリ管理
- **画像キャッシュ**: NSCache使用、最大50MB制限
- **大量データ処理**: ページング (50件/ページ)
- **メモリリーク監視**: Instrumentsで定期チェック

### 5.2 Core Data最適化
- **フェッチリクエスト**: バッチサイズ50、Prefetch有効
- **インデックス**: name, distillery, createdAtにインデックス追加
- **バックグラウンド処理**: 重い操作はバックグラウンドContext使用

### 5.3 UIレスポンシブ性
- **遅延読み込み**: LazyVStack, AsyncImage使用
- **スケルトンUI**: データ読み込み中のプレースホルダー表示
- **スムーズアニメーション**: 60fps維持、withAnimation使用

## 6. 成功指標とKPI

### 5.1 技術的成功指標
- **安定性**: 1週間の継続使用でクラッシュゼロ
  - 測定方法: 毎日30分使用、クラッシュログ監視
  - 合格基準: Xcode Organizer でクラッシュレポート0件
- **データ安全性**: データ消失ゼロ
  - 測定方法: アプリ強制終了・端末再起動テスト
  - 合格基準: 全データが正確に復元される
- **レスポンス性**: 基本操作1秒以内
  - 測定対象: ボトル追加、一覧表示、検索、残量更新
  - 測定環境: iPhone 12 (iOS 16.0) 以上
  - 合格基準: Time Profilerで1秒以内を確認
- **容量効率**: 100本で200MB以下（写真含む）
  - 計算根拠: ボトル1本あたり2MB (写真2枚×1MB)
  - 測定方法: ストレージ使用量をSettings.appで確認

### 5.2 機能的成功指標
- **登録効率**: 1本の登録が3分以内
  - 測定対象: 手動入力による完全登録（写真撮影含む）
  - 合格基準: ストップウォッチ計測で3分以内
- **検索効率**: 目的のボトルが10秒以内で発見
  - 測定条件: 100本登録状態での部分一致検索
  - 合格基準: キーワード入力〜該当ボトル選択まで10秒以内
- **更新効率**: 残量更新が30秒以内
  - 測定対象: ボトル詳細画面での残量変更
  - 合格基準: 画面表示〜保存完了まで30秒以内
- **学習容易性**: 初回利用で基本操作を習得
  - 測定方法: アプリ初回起動から最初のボトル登録完了まで
  - 合格基準: ヘルプなしで15分以内に完了

### 5.3 個人利用成功指標
- **継続使用**: 1ヶ月間毎日使用できる
  - 測定方法: 使用ログによる継続日数カウント
  - 合格基準: 30日中25日以上の使用
- **データ蓄積**: 50本以上のボトル管理
  - 測定時期: MVP完成後3ヶ月以内
  - 合格基準: 実際の登録ボトル数が50本以上
- **習慣化**: 飲酒時の記録が自然に行える
  - 測定方法: 記録頻度の主観評価
  - 合格基準: 飲酒の90%以上で記録を実施

## 6. リスク管理と対策

### 6.1 技術リスク
| リスク | 影響度 | 対策 |
|--------|---------|------|
| Core Data設計ミス | 高 | 段階的実装、早期テスト |
| メモリリーク | 中 | 画像処理の最適化 |
| パフォーマンス劣化 | 中 | 事前の容量制限設定 |

### 6.2 開発リスク
| リスク | 影響度 | 対策 |
|--------|---------|------|
| スコープクリープ | 高 | この文書での厳格な機能管理 |
| 技術学習遅延 | 中 | シンプルな技術選択 |
| モチベーション低下 | 中 | 短期間での成果創出 |

### 6.3 ユーザビリティリスク
| リスク | 影響度 | 対策 |
|--------|---------|------|
| 操作が分かりにくい | 中 | 直感的なUI設計 |
| 入力が面倒 | 中 | 必須項目の最小化 |

### 6.4 セキュリティ要件

#### 6.4.1 データ保護
| 項目 | 仕様 | 理由 |
|------|------|------|
| ローカルデータ暗号化 | iOS標準暴号化 (NSFileProtectionComplete) | 端末紛失時のデータ保護 |
| 写真ファイル暗号化 | ファイルシステムレベル暗号化 | コレクション情報のプライバシー保護 |
| アプリロック | 将来実装予定 | 他人がアプリを開いた際の保護 |

#### 6.4.2 プライバシー要件
- **データ収集**: アプリ内データのみ、外部送信なし
- **権限管理**: カメラ・フォトライブラリのみ要求
- **トラッキング**: 解析ツール不使用、ユーザー行動追跡なし

### 6.5 テスト戦略

#### 6.5.1 テストピラミッド
- **Unit Tests (70%)**: Repository層、ViewModelロジック
- **Integration Tests (20%)**: Core Data操作、ファイルI/O
- **UI Tests (10%)**: クリティカルパスのみ

#### 6.5.2 テストカバレッジ目標
- **コードカバレッジ**: 80%以上
- **クリティカルパス**: 100%カバー
- **エラーシナリオ**: 主要エラーの90%カバー

#### 6.5.3 自動テスト実行
- **CI/CD**: GitHub Actionsでビルド時自動実行
- **パフォーマンステスト**: 週次手動実行
- **回帰テスト**: リリース前に必須実行

### 6.6 エラーハンドリング戦略

#### 6.4.1 データ関連エラー
| エラーシナリオ | 対応方法 | ユーザーへの表示 |
|-------------|----------|----------------|
| Core Data保存失敗 | リトライ機能、ローカルバックアップ | "保存に失敗しました。再試行しますか？" |
| データ破損検出 | データ整合性チェック、修復試行 | "データに問題が見つかりました。修復しますか？" |
| バリデーションエラー | 入力値チェック、ハイライト表示 | "銘柄名は必須です" (赤文字) |

#### 6.4.2 メディア関連エラー
| エラーシナリオ | 対応方法 | ユーザーへの表示 |
|-------------|----------|----------------|
| カメラアクセス拒否 | 設定アプリへのディープリンク | "カメラの使用許可が必要です。設定を開きますか？" |
| フォトライブラリアクセス拒否 | 手動入力モードへ回避 | "写真へのアクセスが拒否されました。後で追加できます" |
| 写真保存失敗 | ストレージ容量チェック、リトライ | "写真の保存に失敗しました。ストレージ容量を確認してください" |
| 写真ファイル破損 | プレースホルダー画像表示 | "写真を読み込めませんでした" |

#### 6.4.3 システムリソースエラー
| エラーシナリオ | 対応方法 | ユーザーへの表示 |
|-------------|----------|----------------|
| メモリ不足 | 大きな写真の解放、キャッシュクリア | 自動処理 (ユーザーに非表示) |
| ストレージ不足 | 利用可能容量チェック、警告表示 | "ストレージ容量が不足しています。不要なファイルを削除してください" |
| ネットワークエラー | オフラインモード継続 | 影響なし (オフラインファースト) |

#### 6.4.4 エラーログ戦略
- **ログレベル**: Error > Warning > Info > Debug
- **ログ保存**: 最大100MB、ローテーションあり
- **クラッシュレポート**: 自動収集、Xcode Organizer連携
- **ユーザーフィードバック**: アプリ内フィードバック機能を将来的に追加

## 7. 国際化対応計画

### 7.1 MVPでの対応
- **日本語メイン**: メインユーザーが日本人のため
- **Localizable.strings**: 将来の多言語対応に備えて準備
- **数値フォーマット**: 日本の単位系 (ml, 度数) を標準とする

### 7.2 将来の国際化計画
- **英語対応**: App Store国際展開時に実装
- **単位系切り替え**: オンス (oz) 、ファーレンハイト (°F) 対応
- **地域固有フォーマット**: 日付、数値、通貨表示

## 8. MVP完成後のロードマップ

### 8.1 短期計画（MVP完成後1-3ヶ月）
1. **CloudKit同期実装** - 複数デバイス対応
2. **統計機能** - 基本的なグラフ表示
3. **通知機能** - 残量アラート

### 8.2 中期計画（3-6ヶ月）
1. **バーコードスキャン** - 商品情報自動取得
2. **ウィッシュリスト** - 欲しいボトル管理
3. **データエクスポート** - CSV出力

### 8.3 長期計画（6ヶ月以降）
1. **マネタイズ検討** - App Store配布準備
2. **Apple Watch対応** - 在庫確認の簡便化
3. **ソーシャル機能** - コレクション共有

---

## 9. 重要な決定事項

### 9.1 技術選択の理由
- **SwiftUI採用**: モダンなUI、iPad対応の容易さ
- **Core Data採用**: iOS標準、CloudKit連携の容易さ
- **ローカルファースト**: オフライン動作、同期は後回し

### 9.2 機能除外の理由
- **マネタイズ機能除外**: MVPでは価値提供に集中
- **CloudKit同期除外**: 技術リスクを避け、ローカル完成を優先
- **統計機能除外**: データが蓄積されてから価値が出る

### 9.3 品質基準の設定理由
- **クラッシュゼロ**: 個人利用でも信頼性は最重要
- **1秒以内レスポンス**: 日常使いでのストレス排除
- **データ消失ゼロ**: コレクション記録の価値保護

---

**文書バージョン**: 1.0
**作成日**: 2025-09-23
**最終更新**: 2025-09-23
**作成者**: Claude Code with ultrathink
**承認者**: プロジェクトオーナー

**次のアクション**: データモデル定義書（data-model.md）の作成推奨