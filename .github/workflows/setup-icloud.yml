name: iCloud自動設定

on:
  workflow_dispatch: # 手動実行のみ

permissions:
  contents: write

env:
  BUNDLE_ID: 'com.bottlekeep.whiskey'

jobs:
  setup-icloud:
    name: iCloud CloudKit設定
    runs-on: ubuntu-latest

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pythonをセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: iCloud設定スクリプトを実行
        run: |
          echo "🔧 Running iCloud setup script..."
          python setup-icloud.py "${{ env.BUNDLE_ID }}"

      - name: 変更を確認
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changed Files ==="
          git diff --name-only

      - name: 変更をコミット
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 変更されたファイルを個別に追加
          git add BottleKeeper.xcodeproj/project.pbxproj
          git add BottleKeeper/BottleKeeper.entitlements
          git add BottleKeeper/Services/CoreDataManager.swift

          # コミット作成
          git commit -m "chore: iCloud CloudKit設定を自動適用

          - Container ID: iCloud.${{ env.BUNDLE_ID }}
          - Xcode プロジェクトに iCloud Capability 追加
          - Entitlements ファイルを更新
          - CoreDataManager のコンテナIDを更新

          🤖 Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: 変更をプッシュ
        run: |
          git push

      - name: セットアップ完了通知
        run: |
          echo "✅ iCloud CloudKit setup completed!"
          echo ""
          echo "📱 Container ID: iCloud.${{ env.BUNDLE_ID }}"
          echo ""
          echo "Next: TestFlightビルドを実行してアプリを配信してください"
          echo "https://github.com/${{ github.repository }}/actions/workflows/ios-build.yml"
