name: iCloudè‡ªå‹•è¨­å®š

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿

permissions:
  contents: write

env:
  BUNDLE_ID: 'com.bottlekeep.whiskey'

jobs:
  setup-icloud:
    name: iCloud CloudKitè¨­å®š
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: iCloudè¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: |
          echo "ğŸ”§ Running iCloud setup script..."
          python setup-icloud.py "${{ env.BUNDLE_ID }}"

      - name: å¤‰æ›´ã‚’ç¢ºèª
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Changed Files ==="
          git diff --name-only

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«è¿½åŠ 
          git add BottleKeeper.xcodeproj/project.pbxproj
          git add BottleKeeper/BottleKeeper.entitlements
          git add BottleKeeper/Services/CoreDataManager.swift

          # ã‚³ãƒŸãƒƒãƒˆä½œæˆ
          git commit -m "chore: iCloud CloudKitè¨­å®šã‚’è‡ªå‹•é©ç”¨

          - Container ID: iCloud.${{ env.BUNDLE_ID }}
          - Xcode ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« iCloud Capability è¿½åŠ 
          - Entitlements ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          - CoreDataManager ã®ã‚³ãƒ³ãƒ†ãƒŠIDã‚’æ›´æ–°

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git push

      - name: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†é€šçŸ¥
        run: |
          echo "âœ… iCloud CloudKit setup completed!"
          echo ""
          echo "ğŸ“± Container ID: iCloud.${{ env.BUNDLE_ID }}"
          echo ""
          echo "Next: TestFlightãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚¢ãƒ—ãƒªã‚’é…ä¿¡ã—ã¦ãã ã•ã„"
          echo "https://github.com/${{ github.repository }}/actions/workflows/ios-build.yml"
