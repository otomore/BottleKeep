name: iOS ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  XCODE_VERSION: '15.0' # ä½¿ç”¨ã™ã‚‹Xcodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  SCHEME: 'BottleKeep'
  PROJECT_PATH: 'BottleKeep.xcodeproj' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  BUNDLE_ID: 'com.bottlekeep.whiskey'

jobs:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  test:
    name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: macos-14 # æœ€æ–°ã®macOSãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
        run: |
          echo "=== Swift Packageã‹ã‚‰Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ ==="

          # Package.swiftã‹ã‚‰Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
          swift package generate-xcodeproj --skip-extra-files

          echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la *.xcodeproj || echo "xcodeprojãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ç¢ºèª
          if [ -f "${{ env.PROJECT_PATH }}" ]; then
            echo "Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ: ${{ env.PROJECT_PATH }}"
          else
            echo "ã‚¨ãƒ©ãƒ¼: Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Swift Package Managerã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±º
        run: |
          if [ -f "${{ env.PROJECT_PATH }}" ]; then
            xcodebuild -resolvePackageDependencies \
              -project ${{ env.PROJECT_PATH }} \
              -scheme ${{ env.SCHEME }}
          else
            echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Swift Packageã¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚"
          fi

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          echo "=== åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒ ã‚’ç¢ºèª ==="
          xcodebuild -project ${{ env.PROJECT_PATH }} -list

          echo "=== ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ ==="
          xcodebuild test \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }}-Package \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
            -resultBundlePath TestResults \
            -enableCodeCoverage YES \
            || echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚­ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: TestResults

  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    name: ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-14
    needs: test # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå¾Œã«å®Ÿè¡Œ

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ä¿å­˜
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # ä¸€æ™‚çš„ãªã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆ
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è¨­å®š
        run: |
          BUILD_NUMBER=$GITHUB_RUN_NUMBER
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

          # Info.plistã®ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’æ›´æ–°
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "BottleKeep/BottleKeep/Info.plist"

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã¨ã‚¹ã‚­ãƒ¼ãƒ ã‚’ç¢ºèª
        run: |
          echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª ==="
          ls -la *.xcodeproj

          echo "=== åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒ ã‚’ç¢ºèª ==="
          xcodebuild -project ${{ env.PROJECT_PATH }} -list

      - name: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          echo "=== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ ==="

          # åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒ ã‚’å–å¾—
          AVAILABLE_SCHEMES=$(xcodebuild -project ${{ env.PROJECT_PATH }} -list | grep -A 20 "Schemes:" | grep "BottleKeep" | head -1 | xargs)

          if [ -z "$AVAILABLE_SCHEMES" ]; then
            echo "BottleKeepã‚¹ã‚­ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
            SCHEME_TO_USE=$(xcodebuild -project ${{ env.PROJECT_PATH }} -list | grep -A 20 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
          else
            SCHEME_TO_USE="$AVAILABLE_SCHEMES"
          fi

          echo "ä½¿ç”¨ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒ : $SCHEME_TO_USE"

          xcodebuild archive \
            -project ${{ env.PROJECT_PATH }} \
            -scheme "$SCHEME_TO_USE" \
            -configuration Release \
            -archivePath $RUNNER_TEMP/BottleKeep.xcarchive \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM=${{ secrets.TEAM_ID }} \
            PRODUCT_BUNDLE_IDENTIFIER=${{ env.BUNDLE_ID }}

      - name: IPAã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/BottleKeep.xcarchive \
            -exportPath $RUNNER_TEMP/ipa \
            -exportOptionsPlist ExportOptions.plist

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: BottleKeep-IPA
          path: $RUNNER_TEMP/ipa/*.ipa

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’å‰Šé™¤
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision || true

  # TestFlighté…ä¿¡ã‚¸ãƒ§ãƒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  deploy-testflight:
    name: TestFlightã¸é…ä¿¡
    runs-on: macos-14
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: IPAã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: BottleKeep-IPA
          path: ./ipa

      - name: App Store Connectã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          # API Keyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          echo "$APP_STORE_CONNECT_API_KEY" > AuthKey.p8

          xcrun altool --upload-app \
            --type ios \
            --file ./ipa/*.ipa \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

      - name: Slackã¸é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "BottleKeep v${{ github.run_number }} ãŒTestFlightã«é…ä¿¡ã•ã‚Œã¾ã—ãŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš€ BottleKeep ãŒTestFlightã«é…ä¿¡ã•ã‚Œã¾ã—ãŸ*\nâ€¢ ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}\nâ€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nâ€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}