name: iOS ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # push:
  #   branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  XCODE_VERSION: '26.0' # ä½¿ç”¨ã™ã‚‹Xcodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  SCHEME: 'BottleKeeper'
  PROJECT_PATH: 'BottleKeeper.xcodeproj' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  BUNDLE_ID: 'com.bottlekeep.whiskey'

jobs:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  test:
    name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: macos-15 # æœ€æ–°ã®macOSãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¹ã‚­ãƒ¼ãƒ ã®ç¢ºèª
        run: |
          echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚’ç¢ºèª ==="
          ls -la BottleKeeper.xcodeproj/

          echo "=== BottleKeeperãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª ==="
          ls -la BottleKeeper/

          echo "=== åˆ©ç”¨å¯èƒ½ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç¢ºèª ==="
          xcodebuild -list -project ${{ env.PROJECT_PATH }} || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ç¢ºèªä¸­..."

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          echo "=== ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ ==="
          # ã‚¹ã‚­ãƒ¼ãƒ ä¸è¦ã®ç›´æ¥ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæŒ‡å®šã§ãƒ“ãƒ«ãƒ‰
          xcodebuild build \
            -project BottleKeeper.xcodeproj \
            -scheme BottleKeeper \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=26.0' \
            -configuration Debug \
            || echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸãŒç¶™ç¶šã—ã¾ã™"
          echo "âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults

  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    name: ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-15
    needs: test # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå¾Œã«å®Ÿè¡Œ

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64_NEW || secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ä¿å­˜
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # ä¸€æ™‚çš„ãªã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆ
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’å‹•çš„ã«å–å¾—
          echo "=== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª ==="

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
          PROFILE_CONTENT=$(security cms -D -i $PP_PATH)

          # å„å€¤ã‚’å®‰å…¨ã«æŠ½å‡ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          PROFILE_NAME=$(echo "$PROFILE_CONTENT" | plutil -extract Name raw - 2>/dev/null || echo "")
          PROFILE_UUID=$(echo "$PROFILE_CONTENT" | plutil -extract UUID raw - 2>/dev/null || echo "")

          # Team IDã¯è¤‡æ•°ã®å ´æ‰€ã«ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€é †ç•ªã«è©¦è¡Œ
          PROFILE_TEAM_ID=""
          if [ -z "$PROFILE_TEAM_ID" ]; then
            # ApplicationIdentifierPrefixã®æœ€åˆã®è¦ç´ ã‚’å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract ApplicationIdentifierPrefix.0 raw - 2>/dev/null || echo "")
          fi
          if [ -z "$PROFILE_TEAM_ID" ]; then
            # Entitlementså†…ã®com.apple.developer.team-identifier
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract Entitlements.com.apple.developer.team-identifier raw - 2>/dev/null || echo "")
          fi
          if [ -z "$PROFILE_TEAM_ID" ]; then
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract TeamIdentifier raw - 2>/dev/null || echo "")
          fi
          if [ -z "$PROFILE_TEAM_ID" ]; then
            # TeamIdentifierãŒé…åˆ—ã®å ´åˆ
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract TeamIdentifier.0 raw - 2>/dev/null || echo "")
          fi

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Team IDã‚’è¨­å®š
          if [ -z "$PROFILE_TEAM_ID" ]; then
            PROFILE_TEAM_ID="KRVLW3Y2SL"
            echo "âš ï¸ Team IDãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™: $PROFILE_TEAM_ID"
          fi

          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å: $PROFILE_NAME"
          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«UUID: $PROFILE_UUID"
          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«Team ID: $PROFILE_TEAM_ID"
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "PROFILE_TEAM_ID=$PROFILE_TEAM_ID" >> $GITHUB_ENV

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³ã‚’è©³ç´°ç¢ºèª
          echo "=== ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ç¢ºèª ==="
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

          echo "=== ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°æƒ…å ±ç¢ºèª ==="
          security cms -D -i $PP_PATH | plutil -p -

          echo "=== ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ ==="
          find ~/Library/MobileDevice/Provisioning\ Profiles/ -name "*.mobileprovision" -exec basename {} \; 2>/dev/null || echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

      - name: ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è¨­å®š
        run: |
          BUILD_NUMBER=$GITHUB_RUN_NUMBER
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "ãƒ“ãƒ«ãƒ‰ç•ªå·: $BUILD_NUMBER"

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã¨ã‚¹ã‚­ãƒ¼ãƒ ã‚’ç¢ºèª
        run: |
          echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª ==="
          ls -la BottleKeeper/

          echo "=== Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª ==="
          xcodebuild -list -project ${{ env.PROJECT_PATH }} || echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ç¢ºèªä¸­..."

          echo "=== Info.plistç¢ºèª ==="
          ls -la BottleKeeper/Info.plist

      - name: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          echo "=== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ ==="

          # ã¾ãšã€é–‹ç™ºç”¨ãƒ“ãƒ«ãƒ‰ã‚’è©¦ã¿ã‚‹ï¼ˆç½²åä¸è¦ï¼‰
          xcodebuild build \
            -project BottleKeeper.xcodeproj \
            -scheme BottleKeeper \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Debug \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          echo "âœ… ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰æˆåŠŸ"

          # æœ¬ç•ªç”¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ï¼ˆè¨¼æ˜æ›¸ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿ï¼‰
          if [ -n "${{ secrets.BUILD_CERTIFICATE_BASE64 }}" ]; then
            echo "=== ãƒªãƒªãƒ¼ã‚¹ç”¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚’è©¦è¡Œ ==="
            echo "ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å: ${PROFILE_NAME:-BottleKeeper Distribution}"
            echo "ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«UUID: ${PROFILE_UUID:-N/A}"
            echo "ä½¿ç”¨ã™ã‚‹Team ID: ${PROFILE_TEAM_ID:-KRVLW3Y2SL}"

            # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œï¼ˆå¤±æ•—æ™‚ã¯æ˜ç¢ºã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ï¼‰
            ARCHIVE_SUCCESS=false

            # ã¾ãšåå‰ã§è©¦è¡Œ
            echo "=== åå‰ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚’è©¦è¡Œ ==="
            if xcodebuild archive \
              -project BottleKeeper.xcodeproj \
              -scheme BottleKeeper \
              -destination 'generic/platform=iOS' \
              -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
              -configuration Release \
              DEVELOPMENT_TEAM="${PROFILE_TEAM_ID:-KRVLW3Y2SL}" \
              CODE_SIGN_STYLE=Manual \
              PROVISIONING_PROFILE_SPECIFIER="${PROFILE_NAME:-BottleKeeper Distribution}"; then
              echo "âœ… åå‰ã§ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰æˆåŠŸ"
              ARCHIVE_SUCCESS=true
            else
              echo "åå‰ã§ã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚UUIDã§å†è©¦è¡Œã—ã¾ã™ã€‚"

              # UUIDã§å†è©¦è¡Œ
              if [ -n "$PROFILE_UUID" ]; then
                echo "=== UUIDã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚’è©¦è¡Œ ==="
                if xcodebuild archive \
                  -project BottleKeeper.xcodeproj \
                  -scheme BottleKeeper \
                  -destination 'generic/platform=iOS' \
                  -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
                  -configuration Release \
                  DEVELOPMENT_TEAM="${PROFILE_TEAM_ID:-KRVLW3Y2SL}" \
                  CODE_SIGN_STYLE=Manual \
                  PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID"; then
                  echo "âœ… UUIDã§ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰æˆåŠŸ"
                  ARCHIVE_SUCCESS=true
                else
                  echo "âŒ UUIDã§ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ã‚‚å¤±æ•—ã—ã¾ã—ãŸ"
                fi
              else
                echo "âŒ UUIDãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
              fi
            fi

            # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å­˜åœ¨ç¢ºèª
            if [ "$ARCHIVE_SUCCESS" = true ] && [ -d "$RUNNER_TEMP/BottleKeeper.xcarchive" ]; then
              echo "âœ… ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
              ls -la $RUNNER_TEMP/BottleKeeper.xcarchive
            else
              echo "âŒ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo "RUNNER_TEMPå†…å®¹:"
              ls -la $RUNNER_TEMP/
              exit 1
            fi
          fi

          echo "âœ… ãƒ“ãƒ«ãƒ‰å‡¦ç†å®Œäº†"

      - name: IPAã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        run: |
          echo "=== IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹ ==="

          # å‹•çš„ã«ExportOptions.plistã‚’ç”Ÿæˆ
          echo "=== å‹•çš„ExportOptions.plistã‚’ç”Ÿæˆ ==="
          DYNAMIC_PROFILE_NAME="${PROFILE_NAME:-BottleKeeper Distribution}"
          echo "ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å: $DYNAMIC_PROFILE_NAME"

          # å…ƒã®ExportOptions.plistã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å‹•çš„ã«æ›´æ–°
          cp ExportOptions.plist $RUNNER_TEMP/ExportOptions.plist

          # sedã§ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã¨Team IDã‚’å‹•çš„ã«ç½®æ›ï¼ˆmacOSå¯¾å¿œï¼‰
          sed -i '' "s/BottleKeeper Distribution/$DYNAMIC_PROFILE_NAME/g" $RUNNER_TEMP/ExportOptions.plist
          sed -i '' "s/KRVLW3Y2SL/$PROFILE_TEAM_ID/g" $RUNNER_TEMP/ExportOptions.plist

          echo "âœ… å‹•çš„ExportOptions.plistç”Ÿæˆå®Œäº†"
          cat $RUNNER_TEMP/ExportOptions.plist

          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å­˜åœ¨ç¢ºèª
          if [ -d "$RUNNER_TEMP/BottleKeeper.xcarchive" ]; then
            echo "âœ… ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"

            # IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            xcodebuild -exportArchive \
              -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
              -exportPath $RUNNER_TEMP/ipa \
              -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist

            echo "âœ… IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†"
            ls -la $RUNNER_TEMP/ipa/
          else
            echo "âŒ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: BottleKeeper-IPA
          path: ${{ runner.temp }}/ipa/

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’å‰Šé™¤
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision || true

  # TestFlighté…ä¿¡ã‚¸ãƒ§ãƒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  deploy-testflight:
    name: TestFlightã¸é…ä¿¡
    runs-on: macos-15
    needs: build
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: IPAã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: BottleKeeper-IPA
          path: ./ipa

      - name: App Store Connect APIã‚­ãƒ¼ã‚’è¨­å®š
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          echo "=== App Store Connect APIè¨­å®š ==="

          # API Key ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆBase64ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼‰
          mkdir -p ~/private_keys

          # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã®æ”¹å–„ç‰ˆ - æ”¹è¡Œæ–‡å­—ã‚’é™¤å»ã—ã¦ã‹ã‚‰ãƒ‡ã‚³ãƒ¼ãƒ‰
          echo "$APP_STORE_CONNECT_API_KEY" | tr -d '\n' | base64 -d > ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’è¨­å®š
          chmod 600 ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

          # APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨æ¤œè¨¼
          if [ -f ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 ]; then
            FILE_SIZE=$(stat -f%z ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8)
            echo "âœ… APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº† (ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes)"

            # ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€åˆã¨æœ€å¾Œã®è¡Œã‚’ç¢ºèª
            echo "ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ç¢ºèª:"
            head -1 ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8
            tail -1 ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

            # APIã‚­ãƒ¼ã®å½¢å¼ç¢ºèª
            if head -1 ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 | grep -q "BEGIN PRIVATE KEY"; then
              echo "âœ… æ­£ã—ã„PEMãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"

              # OpenSSLã§APIã‚­ãƒ¼ã‚’æ¤œè¨¼
              if openssl ec -in ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 -noout 2>/dev/null; then
                echo "âœ… OpenSSLã§æœ‰åŠ¹ãªECã‚­ãƒ¼ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"
              else
                echo "âŒ OpenSSLã§ã‚­ãƒ¼ã®æ¤œè¨¼ã«å¤±æ•—"
                echo "OpenSSLã‚¨ãƒ©ãƒ¼è©³ç´°:"
                openssl ec -in ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 -noout 2>&1 || true
                exit 1
              fi
            else
              echo "âŒ ä¸æ­£ãªPEMãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
              echo "å®Ÿéš›ã®æœ€åˆã®è¡Œ (hex):"
              head -1 ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 | xxd
              echo "Secretå†…å®¹ã®æœ€åˆã®100æ–‡å­— (hex):"
              echo "$APP_STORE_CONNECT_API_KEY" | head -c 100 | xxd
              exit 1
            fi
          else
            echo "âŒ APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          # APIè¨­å®šã®è©³ç´°ç¢ºèª
          echo "âœ… APIè¨­å®šã®è©³ç´°ç¢ºèª:"
          echo "- API Key ID: ${APP_STORE_CONNECT_API_KEY_ID}"
          echo "- Issuer ID: ${APP_STORE_CONNECT_ISSUER_ID}"
          echo "- API Key file path: ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"

          # æœŸå¾…å€¤ã¨ã®æ¯”è¼ƒ
          echo "æœŸå¾…å€¤ã¨ã®æ¯”è¼ƒ:"
          echo "- æœŸå¾…API Key ID: 3HFGXYNO7U2Q"
          echo "- å®Ÿéš›API Key ID: ${APP_STORE_CONNECT_API_KEY_ID}"
          echo "- æœŸå¾…Issuer ID: 69a6de80-2c1a-47e3-e053-5b8c7c11a4d1"
          echo "- å®Ÿéš›Issuer ID: ${APP_STORE_CONNECT_ISSUER_ID}"

          if [ "$APP_STORE_CONNECT_API_KEY_ID" != "3HFGXYNO7U2Q" ]; then
            echo "âŒ API Key IDãŒä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi

          if [ "$APP_STORE_CONNECT_ISSUER_ID" != "69a6de80-2c1a-47e3-e053-5b8c7c11a4d1" ]; then
            echo "âŒ Issuer IDãŒä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… API Key ID ã¨ Issuer ID ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™"

      - name: TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          echo "=== TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼ˆæœ€æ–°APIä½¿ç”¨ï¼‰ ==="

          # IPAãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          IPA_FILE=$(find ./ipa -name "*.ipa" | head -1)

          if [ -f "$IPA_FILE" ]; then
            echo "âœ… IPAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $IPA_FILE"

            # IPAãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ã‚’ç¢ºèª
            IPA_SIZE=$(stat -f%z "$IPA_FILE")
            echo "IPAãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${IPA_SIZE} bytes"

            # APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            API_KEY_FILE=~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8
            if [ -f "$API_KEY_FILE" ]; then
              echo "âœ… APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™: $API_KEY_FILE"
            else
              echo "âŒ APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $API_KEY_FILE"
              ls -la ~/private_keys/
              exit 1
            fi

            # Pythonã§App Store Connect APIã‚’ç›´æ¥ä½¿ç”¨ã—ã¦TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            echo "Pythonã§App Store Connect APIã‚’ç›´æ¥ä½¿ç”¨ã—ã¦TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œä¸­..."

            # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
            cat > upload_to_testflight.py << 'EOF'
import json
import time
import jwt
import requests
import os
from datetime import datetime, timedelta

def create_jwt_token(key_id, issuer_id, private_key_path):
    """Create JWT token for App Store Connect API"""
    with open(private_key_path, 'r') as key_file:
        private_key = key_file.read()

    now = datetime.utcnow()
    payload = {
        'iss': issuer_id,
        'exp': now + timedelta(minutes=20),
        'aud': 'appstoreconnect-v1',
        'iat': now
    }

    headers = {
        'kid': key_id,
        'typ': 'JWT',
        'alg': 'ES256'
    }

    token = jwt.encode(payload, private_key, algorithm='ES256', headers=headers)
    return token

def upload_to_testflight(ipa_path, key_id, issuer_id, private_key_path, bundle_id):
    """Upload IPA to TestFlight using App Store Connect API"""
    try:
        print(f"ğŸš€ TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹...")
        print(f"- Bundle ID: {bundle_id}")
        print(f"- API Key ID: {key_id}")
        print(f"- Issuer ID: {issuer_id[:8]}****")

        # Create JWT token
        token = create_jwt_token(key_id, issuer_id, private_key_path)
        print("âœ… JWT tokenä½œæˆæˆåŠŸ")

        headers = {
            'Authorization': f'Bearer {token}',
            'Content-Type': 'application/json'
        }

        # Test API connection first
        print("ğŸ”— App Store Connect APIæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...")
        test_url = 'https://api.appstoreconnect.apple.com/v1/apps'
        test_response = requests.get(test_url, headers=headers, timeout=30)

        if test_response.status_code == 200:
            print("âœ… App Store Connect APIèªè¨¼æˆåŠŸ")
            apps = test_response.json().get('data', [])
            print(f"ğŸ“± å–å¾—ã—ãŸã‚¢ãƒ—ãƒªæ•°: {len(apps)}")

            # Find our app by bundle ID
            target_app = None
            for app in apps:
                if app['attributes']['bundleId'] == bundle_id:
                    target_app = app
                    break

            if target_app:
                print(f"âœ… ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: {target_app['attributes']['name']}")
                print(f"ğŸ‰ TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™å®Œäº†ï¼")
                print("ğŸ“ æ³¨æ„: å®Ÿéš›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯multipart/form-dataãŒå¿…è¦ã§ã™ãŒã€")
                print("    APIèªè¨¼ã¯æˆåŠŸã—ã¦ã„ã‚‹ãŸã‚ã€altoolã§å†è©¦è¡Œã—ã¾ã™ã€‚")
                return True
            else:
                print(f"âŒ Bundle ID '{bundle_id}' ã®ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                print("ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒª:")
                for app in apps:
                    print(f"  - {app['attributes']['name']}: {app['attributes']['bundleId']}")
                return False

        else:
            print(f"âŒ App Store Connect APIèªè¨¼å¤±æ•—: {test_response.status_code}")
            print(f"Response: {test_response.text}")
            return False

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        return False

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 6:
        print("Usage: python upload_to_testflight.py <ipa_path> <key_id> <issuer_id> <private_key_path> <bundle_id>")
        sys.exit(1)

    ipa_path, key_id, issuer_id, private_key_path, bundle_id = sys.argv[1:6]
    success = upload_to_testflight(ipa_path, key_id, issuer_id, private_key_path, bundle_id)
    sys.exit(0 if success else 1)
EOF

            # PyJWTã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            python3 -m pip install PyJWT requests

            # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
            if python3 upload_to_testflight.py "$IPA_FILE" "$APP_STORE_CONNECT_API_KEY_ID" "$APP_STORE_CONNECT_ISSUER_ID" "$API_KEY_FILE" "$BUNDLE_ID"; then
              echo "âœ… APIèªè¨¼ãŒæˆåŠŸã—ã¾ã—ãŸã€‚altoolã§å†è©¦è¡Œã—ã¾ã™..."

              # APIèªè¨¼ãŒæˆåŠŸã—ãŸã®ã§ã€altoolã§å†è©¦è¡Œ
              if xcrun altool --upload-app \
                --type ios \
                --file "$IPA_FILE" \
                --apiKey $APP_STORE_CONNECT_API_KEY_ID \
                --apiIssuer $APP_STORE_CONNECT_ISSUER_ID \
                --verbose; then
                echo "ğŸ‰ TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼"
                echo "å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚"
              else
                echo "âŒ altoolã§ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
                echo "APIèªè¨¼ã¯æˆåŠŸã—ã¦ã„ã‚‹ãŸã‚ã€Bundle IDã¾ãŸã¯ã‚¢ãƒ—ãƒªè¨­å®šã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
                exit 1
              fi
            else
              echo "âŒ APIèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±:"
              echo "- API Key ID: ${APP_STORE_CONNECT_API_KEY_ID}"
              echo "- Issuer ID: ${APP_STORE_CONNECT_ISSUER_ID}"
              echo "- Bundle ID: ${BUNDLE_ID}"
              echo "- IPA File: $IPA_FILE (${IPA_SIZE} bytes)"
              echo "- API Key File: $API_KEY_FILE"

              # APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’æœ€çµ‚ç¢ºèª
              echo "APIã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«æœ€çµ‚ç¢ºèª:"
              head -1 "$API_KEY_FILE"
              tail -1 "$API_KEY_FILE"

              exit 1
            fi
          else
            echo "âŒ IPAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ipaãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
            ls -la ./ipa/
            exit 1
          fi

      - name: Slackã¸é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: success() && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "BottleKeeper v${{ github.run_number }} ãŒTestFlightã«é…ä¿¡ã•ã‚Œã¾ã—ãŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš€ BottleKeeper ãŒTestFlightã«é…ä¿¡ã•ã‚Œã¾ã—ãŸ*\nâ€¢ ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}\nâ€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nâ€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}