name: æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ

on:
  # push:
  #   branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  XCODE_VERSION: '16.2'
  SCHEME: 'BottleKeeper'
  PROJECT_PATH: 'BottleKeeper.xcodeproj'
  BUNDLE_ID: 'com.bottlekeep.whiskey'

jobs:
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª
  project-check:
    name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª
    runs-on: macos-15

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚’è©³ç´°ç¢ºèª
        run: |
          echo "=== ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la

          echo "=== Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ« ==="
          ls -la BottleKeeper.xcodeproj/

          echo "=== BottleKeeperãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la BottleKeeper/

          echo "=== ã‚¢ãƒ—ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la BottleKeeper/App/ || echo "Appãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          echo "=== Viewsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la BottleKeeper/Views/ || echo "Viewsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          echo "=== Modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la BottleKeeper/Models/ || echo "Modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          echo "=== Servicesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ==="
          ls -la BottleKeeper/Services/ || echo "Servicesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          echo "=== Assets ==="
          ls -la BottleKeeper/Assets.xcassets/ || echo "AssetsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          echo "=== Core Dataãƒ¢ãƒ‡ãƒ« ==="
          ls -la BottleKeeper/BottleKeeper.xcdatamodeld/ || echo "Core Dataãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

      - name: Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šç¢ºèª
        run: |
          echo "=== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± ==="
          xcodebuild -list -project ${{ env.PROJECT_PATH }}

  # åŸºæœ¬ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    name: åŸºæœ¬ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: macos-15
    needs: project-check

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: iOS ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§åŸºæœ¬ãƒ“ãƒ«ãƒ‰
        run: |
          echo "=== iOS ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ ==="

          # åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ç¢ºèª
          echo "=== åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ ==="
          xcrun simctl list devices available | grep iPhone

          echo "=== åŸºæœ¬ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ ==="
          xcodebuild build \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -configuration Debug \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          echo "âœ… iOS ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ“ãƒ«ãƒ‰æˆåŠŸ"

      - name: ãƒ“ãƒ«ãƒ‰è¨­å®šã®ç¢ºèª
        run: |
          echo "=== ãƒ“ãƒ«ãƒ‰è¨­å®šç¢ºèª ==="
          xcodebuild -showBuildSettings \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -configuration Debug \
            | grep -E "(PRODUCT_BUNDLE_IDENTIFIER|IPHONEOS_DEPLOYMENT_TARGET|SUPPORTED_PLATFORMS|SWIFT_VERSION)"

  # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆSwiftæ§‹æ–‡ç¢ºèªï¼‰
  syntax-check:
    name: Swiftæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
    runs-on: macos-15
    needs: project-check

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Swiftæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          echo "=== Swiftæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ ==="
          find BottleKeeper -name "*.swift" | while read file; do
            echo "ãƒã‚§ãƒƒã‚¯ä¸­: $file"
            xcrun swiftc -parse "$file" -target arm64-apple-ios26.0 || echo "è­¦å‘Š: $file ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          done
          echo "âœ… Swiftæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆç½²åãªã—ï¼‰
  archive-test:
    name: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: macos-15
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ï¼ˆç½²åãªã—ï¼‰
        run: |
          echo "=== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ ==="
          xcodebuild archive \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination 'generic/platform=iOS' \
            -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
            -configuration Debug \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -quiet

          echo "âœ… ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰æˆåŠŸ"

          echo "=== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…å®¹ç¢ºèª ==="
          ls -la $RUNNER_TEMP/BottleKeeper.xcarchive/

      - name: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: BottleKeeper-Archive-Debug
          path: ${{ runner.temp }}/BottleKeeper.xcarchive/

  # çµæžœã‚µãƒžãƒªãƒ¼
  build-summary:
    name: ãƒ“ãƒ«ãƒ‰çµæžœã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [project-check, build-test, syntax-check, archive-test]
    if: always()

    steps:
      - name: çµæžœã‚µãƒžãƒªãƒ¼
        run: |
          echo "## ðŸ¾ BottleKeeper ãƒ“ãƒ«ãƒ‰çµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| ã‚¸ãƒ§ãƒ– | çµæžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª | ${{ needs.project-check.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åŸºæœ¬ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ | ${{ needs.build-test.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Swiftæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ | ${{ needs.syntax-check.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ | ${{ needs.archive-test.result == 'success' && 'âœ… æˆåŠŸ' || needs.archive-test.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-test.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“± å¯¾å¿œç’°å¢ƒ" >> $GITHUB_STEP_SUMMARY
            echo "- iOS 26.0+" >> $GITHUB_STEP_SUMMARY
            echo "- iPadOS 26.0+" >> $GITHUB_STEP_SUMMARY
            echo "- SwiftUI + Core Data" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ãƒ“ãƒ«ãƒ‰ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**" >> $GITHUB_STEP_SUMMARY
          fi